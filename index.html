<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PIN-PON SHOP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #000000;
            --secondary: #fb7701;
            --accent: #E60023;
            --bg: #f7f7f7;
            --white: #ffffff;
            --text: #333333;
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0,0,0,0.06);
            --gold: #ffc107;
            --success: #00a65a; /* Color verde para verificaciones */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 160px; }

        /* --- HEADER & SEARCH --- */
        header { background: var(--white); position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .logo { font-size: 1.3rem; font-weight: 900; letter-spacing: -0.5px; color: var(--primary); text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .logo span { color: var(--secondary); }
        .menu-btn { font-size: 1.4rem; cursor: pointer; color: #333; }

        .search-container { padding: 0 15px 10px 15px; position: relative; }
        .search-wrapper { position: relative; }
        .search-input { width: 100%; background: #f0f0f0; border: none; padding: 10px 40px 10px 15px; border-radius: 20px; font-size: 0.95rem; color: #333; transition: 0.3s; }
        .search-input:focus { background: #e8e8e8; box-shadow: 0 0 0 2px rgba(251, 119, 1, 0.1); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }

        /* --- BANNER --- */
        .banner { background: linear-gradient(135deg, #1a1a1a, #333); color: white; padding: 25px 20px; text-align: center; position: relative; margin-bottom: 5px; }
        .banner h2 { margin: 0; font-size: 1.4rem; font-weight: 700; }
        .banner p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9; }
        .banner-edit-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; cursor:pointer; font-weight: bold; border: 2px dashed #fff; z-index: 10; }

        /* --- CATEGORIES --- */
        .categories-scroll { display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px; scrollbar-width: none; background: var(--white); border-bottom: 1px solid #f0f0f0; }
        .categories-scroll::-webkit-scrollbar { display: none; }
        .cat-pill { padding: 6px 14px; border-radius: 4px; white-space: nowrap; font-size: 0.85rem; cursor: pointer; color: #555; font-weight: 500; position: relative; }
        .cat-pill.active { color: var(--secondary); font-weight: 700; }
        .cat-pill.active::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 100%; height: 2px; background: var(--secondary); }

        /* --- PRODUCT GRID --- */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px; }
        .product-card { background: var(--white); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; position: relative; }
        .img-container { width: 100%; aspect-ratio: 1/1; background: #f9f9f9; position: relative; overflow: hidden; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .p-details { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; }
        .p-title { margin: 0 0 5px 0; font-size: 0.85rem; font-weight: 400; color: #333; line-height: 1.3; height: 2.6em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        
        .p-price-row { display: flex; align-items: baseline; gap: 5px; margin-bottom: 5px; }
        .p-price { font-size: 1.1rem; font-weight: 800; color: var(--primary); }
        .p-currency { font-size: 0.7rem; font-weight: 600; }
        .p-old-price { font-size: 0.75rem; text-decoration: line-through; color: #999; }
        
        .p-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .p-sales { font-size: 0.7rem; color: #777; background: #f0f0f0; padding: 2px 4px; border-radius: 2px; }
        
        /* Controles en la tarjeta */
        .card-controls { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        .qty-mini { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 20px; overflow: hidden; background: #fff; }
        .qty-mini-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: none; border: none; font-size: 0.9rem; color: #333; cursor: pointer; }
        .qty-mini-val { font-size: 0.8rem; font-weight: 600; min-width: 16px; text-align: center; }
        .add-btn-mini { background: var(--white); border: 1px solid var(--secondary); color: var(--secondary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .add-btn-mini:active { background: var(--secondary); color: white; }

        .out-of-stock-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; font-weight: bold; color: #999; z-index: 10; font-size: 0.9rem; backdrop-filter: grayscale(1); }

        /* --- FOOTER DE CONTACTO --- */
        .shop-footer { background: #232f3e; color: white; padding: 30px 20px; margin-top: 20px; text-align: center; }
        .trust-badges { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .badge-item { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.8rem; opacity: 0.9; }
        .badge-item i { font-size: 1.5rem; color: var(--gold); }
        .contact-info { margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .contact-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 0.95rem; }
        .contact-row i { color: var(--secondary); }
        .copyright { font-size: 0.75rem; color: #888; margin-top: 20px; }

        /* --- FAB CART --- */
        .fab-cart { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.3rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 90; transition: transform 0.2s; }
        .fab-cart:active { transform: scale(0.95); }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: white; font-size: 0.75rem; width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(3px); align-items: flex-end; }
        .modal.open { display: flex; }
        .modal-content { background: var(--white); width: 100%; max-height: 85vh; border-radius: 16px 16px 0 0; padding: 20px; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative; display: flex; flex-direction: column; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title-text { font-weight: 700; font-size: 1.2rem; }
        .close-modal { font-size: 1.5rem; background: none; border: none; padding: 5px; cursor: pointer; color: #666; }

        /* --- FORMS --- */
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #f9f9f9; -webkit-appearance: none; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #ff4444; color: white; }
        .btn-success { background: #00a65a; color: white; }
        .btn-info { background: #3498db; color: white; }

        /* --- ADMIN OVERLAY --- */
        #maintenance-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px; }
        .admin-controls-panel { background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 10px; }

        /* --- NUEVO: ESTILOS PARA CHECKBOX BONITOS --- */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .checkbox-container input[type="checkbox"] {
            display: none; /* Oculta el nativo */
        }

        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            background: white;
            transition: all 0.2s;
        }

        /* Cuando est치 activo */
        .checkbox-container.active {
            background: #e8f5e9;
            border-color: var(--success);
        }

        .checkbox-container.active .custom-checkbox {
            background: var(--success);
            border-color: var(--success);
        }

    </style>
</head>
<body>

    <div id="maintenance-overlay">
        <i class="fas fa-tools fa-4x" style="color: var(--secondary); margin-bottom: 20px;"></i>
        <h2 style="color: #333;">TIENDA EN MANTENIMIENTO</h2>
        <p style="color: #666; max-width: 300px; margin: 10px auto;">Estamos actualizando nuestro inventario. Vuelve en unos minutos.</p>
        <button onclick="promptAdminLogin()" style="margin-top: 40px; background: transparent; border:none; color: #999; text-decoration: underline;">Acceso Propietario</button>
    </div>

    <header>
        <div class="header-top">
            <div class="logo">
                <i class="fas fa-bolt" style="color: var(--gold);"></i>
                PIN-PON <span>SHOP</span>
                <span id="admin-indicator" style="display:none; background:red; color:white; font-size:0.5rem; padding:2px 4px; border-radius:4px; margin-left:5px;">ADMIN</span>
            </div>
            <i class="fas fa-bars menu-btn" onclick="openMenu()"></i>
        </div>
        <div class="search-container">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="search-bar" placeholder="Buscar en Pin-Pon Shop..." onkeyup="searchProducts()">
            </div>
        </div>
    </header>

    <div class="banner" id="promo-banner">
        <h2 id="banner-title">...</h2>
        <p id="banner-subtitle">...</p>
        <div class="banner-edit-overlay" onclick="editBanner()">
            <i class="fas fa-edit"></i> Editar Banner
        </div>
    </div>

    <div class="categories-scroll" id="category-list"></div>

    <div class="grid" id="product-grid"></div>

    <footer class="shop-footer">
        <div class="trust-badges">
            <div class="badge-item"><i class="fas fa-shield-alt"></i><span>Compra Segura</span></div>
            <div class="badge-item"><i class="fas fa-truck"></i><span>Domicilio Gratis</span></div>
            <div class="badge-item"><i class="fas fa-undo"></i><span>Garant칤a</span></div>
        </div>
        <div class="contact-info">
            <div class="contact-row"><i class="fas fa-phone-alt"></i> 59207040</div>
            <div class="contact-row"><i class="fas fa-envelope"></i> odh190302@gmail.com</div>
        </div>
        <div class="copyright">춸 2024 PIN-PON SHOP. Todos los derechos reservados.</div>
    </footer>

    <div class="fab-cart" onclick="openCart()">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cart-count">0</span>
    </div>

    <div class="modal" id="menu-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title-text">Men칰</span>
                <button class="close-modal" onclick="closeModal('menu-modal')">&times;</button>
            </div>
            
            <div id="admin-panel" style="display:none;">
                <div class="admin-controls-panel">
                    <h4 style="margin-top:0;">游 Panel Administrador</h4>
                    
                    <label class="checkbox-container" id="container-maintenance">
                        <input type="checkbox" id="check-maintenance" onchange="toggleMaintenance(this)">
                        <div class="custom-checkbox"><i class="fas fa-check"></i></div>
                        <span>Activar Modo Mantenimiento</span>
                    </label>

                    <label style="font-size:0.8rem; margin-top:10px; display:block;">Tasa de Cambio (1 USD = X MN)</label>
                    <input type="number" id="exchange-rate" value="300" onchange="updateSettings()" style="margin-bottom:10px;">
                    
                    <button class="btn btn-success" onclick="openProductForm()"><i class="fas fa-plus"></i> Agregar Producto</button>
                    <button class="btn btn-primary" onclick="openCategoryManager(true)"><i class="fas fa-list"></i> Gestionar Categor칤as</button>
                </div>
                <button class="btn btn-danger" onclick="logoutAdmin()">Cerrar Sesi칩n Admin</button>
            </div>

            <button id="login-btn" class="btn btn-primary" onclick="promptAdminLogin()">Soy el Administrador</button>
            <div style="margin-top:20px; font-size:0.9rem; color:#777; text-align:center;">
                <p>PIN-PON SHOP v6.0 (Cloud)</p>
            </div>
        </div>
    </div>

    <div class="modal" id="product-modal">
        <div class="modal-content">
            <button class="close-modal" style="position: absolute; right: 15px; top: 15px; z-index: 10;" onclick="closeModal('product-modal')">&times;</button>
            <img id="modal-img" class="img-large" src="" alt="" style="width:100%; height:300px; object-fit:contain;">
            <h2 id="modal-title" style="margin: 10px 0 0 0; font-size: 1.3rem;"></h2>
            
            <label class="rating-label">Clasifique nuestro producto:</label>
            <div class="rating-interactive" id="modal-rating-container">
                <i class="far fa-star" onclick="rateProduct(1)"></i>
                <i class="far fa-star" onclick="rateProduct(2)"></i>
                <i class="far fa-star" onclick="rateProduct(3)"></i>
                <i class="far fa-star" onclick="rateProduct(4)"></i>
                <i class="far fa-star" onclick="rateProduct(5)"></i>
            </div>

            <p id="modal-desc" style="color: #666; line-height: 1.5; font-size: 0.95rem;"></p>
            <div style="display: flex; align-items: baseline;">
                <span class="detail-price" id="modal-price"></span>
                <span class="detail-mn" id="modal-mn-price"></span>
            </div>

            <div class="detail-actions">
                <div class="qty-selector-large">
                    <button class="qty-btn-large" onclick="updateModalQty(-1)">-</button>
                    <div class="qty-display-large" id="modal-qty-display">1</div>
                    <button class="qty-btn-large" onclick="updateModalQty(1)">+</button>
                </div>
                <button class="btn-add-large" id="modal-add-btn" onclick="addToCartFromModal()">Agregar al Carrito</button>
            </div>
            
            <div id="admin-product-actions" style="display:none; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
                <p style="font-size: 0.8rem; font-weight: bold; color: var(--secondary);">OPCIONES ADMIN:</p>
                <div style="display:flex; gap: 10px;">
                    <button class="btn btn-info" onclick="editProductFromModal()">Editar</button>
                    <button class="btn btn-danger" onclick="deleteProductFromModal()">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title-text">Tu Carrito</span>
                <button class="close-modal" onclick="closeModal('cart-modal')">&times;</button>
            </div>
            <div id="cart-items" style="flex-grow: 1; overflow-y: auto; margin-bottom: 20px;"></div>
            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.2rem; margin-bottom: 15px;">
                    <span>Total:</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <button class="btn btn-secondary" onclick="openCheckout()">Pagar Ahora</button>
            </div>
        </div>
    </div>

    <div class="modal" id="checkout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title-text">Finalizar Compra</span>
                <button class="close-modal" onclick="closeModal('checkout-modal')">&times;</button>
            </div>
            <form id="checkout-form" onsubmit="processOrder(event)">
                <label style="font-size:0.9rem; font-weight:bold;">Datos de Env칤o</label>
                <input type="text" id="c-name" placeholder="Nombre y Apellidos" required>
                <input type="text" id="c-ci" placeholder="Carnet de Identidad" required>
                <input type="text" id="c-address" placeholder="Direcci칩n Exacta" required>
                <input type="tel" id="c-phone" placeholder="Tel칠fono / WhatsApp" required>
                
                <label style="font-size:0.9rem; font-weight:bold;">Fecha de Entrega</label>
                <input type="date" id="c-date" required>
                
                <label style="font-size:0.9rem; font-weight:bold;">Forma de Pago</label>
                <select id="c-payment">
                    <option value="USD (Efectivo)">USD (Efectivo)</option>
                    <option value="MN (Transferencia/Efectivo)">MN (CUP)</option>
                    <option value="Euro">Euro</option>
                    <option value="Zelle">Zelle</option>
                </select>

                <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <strong>Total a Pagar: <span id="checkout-total-display"></span></strong>
                </div>

                <button type="submit" class="btn btn-success"><i class="fab fa-whatsapp"></i> Confirmar Pedido por WhatsApp</button>
            </form>
        </div>
    </div>

    <div class="modal" id="admin-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title-text">Editar Producto</span>
                <button class="close-modal" onclick="closeModal('admin-product-modal')">&times;</button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="p-id">
                <label>Nombre del Producto</label>
                <input type="text" id="p-name" required>
                
                <label>Categor칤a</label>
                <select id="p-category" required></select>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Precio (USD)</label>
                        <input type="number" id="p-price" step="0.01" required>
                    </div>
                    <div style="flex:1">
                        <label>Precio Anterior (Oferta)</label>
                        <input type="number" id="p-old-price" step="0.01">
                    </div>
                </div>

                <label>Descripci칩n</label>
                <textarea id="p-desc" rows="3"></textarea>

                <label>Enlace de la Foto (Recomendado)</label>
                <input type="url" id="p-img-url" placeholder="https://..." onchange="previewUrl(this.value)">

                <label style="font-size:0.8rem; color:#666;">O subir desde galer칤a (Solo im치genes peque침as)</label>
                <input type="file" id="p-image-file" accept="image/*" onchange="handleImageUpload(this)">
                
                <input type="hidden" id="p-image-data">
                <div id="p-image-preview" style="width: 100px; height: 100px; background: #eee; margin-bottom: 15px; border-radius: 8px; overflow: hidden; background-size: cover; background-position: center;"></div>

                <div style="margin-bottom: 20px;">
                    <label class="checkbox-container" id="container-new">
                        <input type="checkbox" id="p-is-new" onchange="toggleCheckStyle(this)"> 
                        <div class="custom-checkbox"><i class="fas fa-check"></i></div>
                        <span>Marcar como NUEVO</span>
                    </label>
                    <label class="checkbox-container" id="container-stock">
                        <input type="checkbox" id="p-stock" onchange="toggleCheckStyle(this)" checked> 
                        <div class="custom-checkbox"><i class="fas fa-check"></i></div>
                        <span>Producto en Existencia</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div class="modal" id="category-manager-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title-text">Categor칤as</span>
                <button class="close-modal" onclick="closeModal('category-manager-modal')">&times;</button>
            </div>
            <div id="category-list-admin" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-category-input" placeholder="Nueva Categor칤a" style="margin:0;">
                <button class="btn btn-success" onclick="addCategory()" style="width: auto; margin:0;">+</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI칍N FIREBASE ---
        // Pega aqu칤 TU configuraci칩n de Firebase (la misma de antes)
        const firebaseConfig = {
            apiKey: "AIzaSyA04fdbHRhwgJVQrEtDJoAm7adm99h6a_w",
            authDomain: "pinponshop-2f5c8.firebaseapp.com",
            projectId: "pinponshop-2f5c8",
            storageBucket: "pinponshop-2f5c8.firebasestorage.app",
            messagingSenderId: "433977596942",
            appId: "1:433977596942:web:9f4fbbd81cf2e640a4f05f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const configRef = db.collection("config").doc("store");
        const productsRef = db.collection("products");
        const categoriesRef = db.collection("categories");

        // --- 2. VARIABLES GLOBALES ---
        const WHATSAPP_NUMBER = "5359207040";
        const ADMIN_PASS = "oscardh190302";

        let state = {
            isAdmin: false,
            maintenance: false, 
            exchangeRate: 300, 
            bannerTitle: "Cargando...", 
            bannerSub: "...", 
            categories: [],     
            products: [],      
            cart: JSON.parse(localStorage.getItem('pinpon_cart')) || [], 
            ratings: JSON.parse(localStorage.getItem('pinpon_ratings')) || {} 
        };

        let tempModalQty = 1;
        let activeModalProductId = null;

        // --- 3. INICIO ---
        function init() {
            // Escuchar Configuraci칩n
            configRef.onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    state.maintenance = data.maintenance || false;
                    state.exchangeRate = data.exchangeRate || 300;
                    state.bannerTitle = data.bannerTitle || "춰Gran Apertura!";
                    state.bannerSub = data.bannerSub || "Env칤os a todo Santiago de Cuba";
                    renderAll();
                } else if(state.isAdmin) {
                    configRef.set({ maintenance: false, exchangeRate: 300, bannerTitle: "Hola", bannerSub: "Mundo" });
                }
            });

            // Escuchar Categor칤as
            categoriesRef.onSnapshot(snapshot => {
                state.categories = snapshot.docs.map(doc => doc.data().name);
                renderCategories();
            });

            // Escuchar Productos
            productsRef.onSnapshot(snapshot => {
                state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(); 
            });
            
            updateCartIcon();
            
            // Verificar sesi칩n admin guardada
            if(localStorage.getItem('pinpon_admin_logged') === 'true'){
                state.isAdmin = true;
            }
            renderAdminUI();
        }

        function saveDataLocal() { 
            localStorage.setItem('pinpon_cart', JSON.stringify(state.cart));
            localStorage.setItem('pinpon_ratings', JSON.stringify(state.ratings));
        }

        // --- 4. UI HELPERS (CHECKBOXES) ---
        function toggleCheckStyle(checkbox) {
            // Encuentra el contenedor padre con la clase .checkbox-container
            const container = checkbox.closest('.checkbox-container');
            if (checkbox.checked) {
                container.classList.add('active');
            } else {
                container.classList.remove('active');
            }
        }

        function toggleMaintenance(checkbox) {
            // Guardar directamente en Firestore
            configRef.update({ maintenance: checkbox.checked })
                .catch(err => alert("Error al cambiar mantenimiento: " + err.message));
            toggleCheckStyle(checkbox);
        }

        // --- 5. RENDERIZADO ---
        function renderAll() {
            renderBanner();
            // renderCategories y Products son autom치ticos por Firestore
            updateCartIcon();
            checkMaintenance();
            renderAdminUI();
        }

        function renderAdminUI() {
            const isAdmin = state.isAdmin;
            document.getElementById('admin-indicator').style.display = isAdmin ? 'inline-block' : 'none';
            document.getElementById('login-btn').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('admin-panel').style.display = isAdmin ? 'block' : 'none';
            
            if(isAdmin) {
                document.getElementById('exchange-rate').value = state.exchangeRate;
                const maintCheck = document.getElementById('check-maintenance');
                if(maintCheck) {
                    maintCheck.checked = state.maintenance;
                    toggleCheckStyle(maintCheck);
                }
            }
        }

        function renderBanner() {
            document.getElementById('banner-title').innerText = state.bannerTitle;
            document.getElementById('banner-subtitle').innerText = state.bannerSub;
            document.querySelector('.banner-edit-overlay').style.display = state.isAdmin ? 'flex' : 'none';
        }

        function checkMaintenance() {
            const overlay = document.getElementById('maintenance-overlay');
            if (state.maintenance && !state.isAdmin) {
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                overlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function renderCategories() {
            const container = document.getElementById('category-list');
            const activePill = document.querySelector('.cat-pill.active')?.innerText || 'Todos';
            
            let html = `<div class="cat-pill ${activePill === 'Todos' ? 'active' : ''}" onclick="selectCategory('all', this)">Todos</div>`;
            state.categories.forEach(cat => {
                html += `<div class="cat-pill ${activePill === cat ? 'active' : ''}" onclick="selectCategory('${cat}', this)">${cat}</div>`;
            });
            container.innerHTML = html;
            
            if(document.getElementById('category-manager-modal').classList.contains('open')) {
                 openCategoryManager(false);
            }
        }

        function selectCategory(cat, el) {
            document.querySelectorAll('.cat-pill').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderProducts(cat);
        }

        function searchProducts() {
            const term = document.getElementById('search-bar').value.toLowerCase();
            renderProducts('all', term);
        }

        function renderProducts(filterCategory = 'all', searchTerm = '') {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';

            let filtered = state.products;
            const activePill = document.querySelector('.cat-pill.active');
            let activeCat = activePill ? activePill.innerText : 'Todos';
            if(filterCategory !== 'all') activeCat = filterCategory;
            
            if (activeCat !== 'Todos') filtered = filtered.filter(p => p.category === activeCat);

            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    (p.desc && p.desc.toLowerCase().includes(searchTerm))
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#999;">No hay productos aqu칤.</div>`;
                return;
            }

            filtered.forEach(p => {
                const isSale = p.oldPrice && p.oldPrice > p.price;
                const percent = isSale ? Math.round(((p.oldPrice - p.price) / p.oldPrice) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = (e) => {
                    if(!e.target.closest('.qty-mini') && !e.target.closest('.add-btn-mini')) openProductModal(p.id);
                };
                
                const stockOverlay = !p.stock ? `<div class="out-of-stock-overlay">AGOTADO</div>` : '';
                const saleBadge = isSale ? `<div style="position:absolute; top:5px; left:5px; background:var(--accent); color:white; font-size:0.7rem; font-weight:bold; padding:2px 6px; border-radius:4px;">-${percent}%</div>` : '';
                const newBadge = p.isNew ? `<span class="p-sales" style="background: var(--secondary); color: white;">Nuevo</span>` : '';

                card.innerHTML = `
                    ${stockOverlay}
                    <div class="img-container">
                        <img src="${p.image}" alt="${p.name}" loading="lazy">
                        ${saleBadge} ${newBadge ? newBadge : ''}
                    </div>
                    <div class="p-details">
                        <h3 class="p-title">${p.name}</h3>
                        <div class="p-price-row">
                            <span class="p-currency">USD</span>
                            <span class="p-price">${p.price.toFixed(2)}</span>
                            ${isSale ? `<span class="p-old-price">$${p.oldPrice.toFixed(2)}</span>` : ''}
                        </div>
                        <div class="card-controls">
                            <div class="qty-mini" onclick="event.stopPropagation()">
                                <button class="qty-mini-btn" onclick="updateCardQty('${p.id}', -1)">-</button>
                                <span class="qty-mini-val" id="card-qty-${p.id}">1</span>
                                <button class="qty-mini-btn" onclick="updateCardQty('${p.id}', 1)">+</button>
                            </div>
                            <div class="add-btn-mini" onclick="addFromCard('${p.id}')"><i class="fas fa-cart-plus"></i></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 6. L칍GICA DE MODALES Y FORMULARIOS ---

        function openProductForm() {
            document.getElementById('product-form').reset();
            document.getElementById('p-id').value = '';
            document.getElementById('p-image-preview').style.backgroundImage = 'none';
            document.getElementById('p-img-url').value = ''; // Limpiar URL
            document.getElementById('p-image-data').value = ''; // Limpiar data
            
            // Reset visual checks
            const checkNew = document.getElementById('p-is-new');
            const checkStock = document.getElementById('p-stock');
            checkNew.checked = false; 
            checkStock.checked = true;
            toggleCheckStyle(checkNew);
            toggleCheckStyle(checkStock);

            const sel = document.getElementById('p-category');
            sel.innerHTML = '';
            state.categories.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);

            openModal('admin-product-modal');
        }

        function editProductFromModal() {
            if (!activeModalProductId) return;
            closeModal('product-modal');
            const p = state.products.find(x => x.id === activeModalProductId);
            
            openProductForm();
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-category').value = p.category;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-old-price').value = p.oldPrice || '';
            document.getElementById('p-desc').value = p.desc || '';
            document.getElementById('p-img-url').value = p.image.startsWith('data:') ? '' : p.image;
            document.getElementById('p-image-data').value = p.image; // Guardar actual por si no cambia
            document.getElementById('p-image-preview').style.backgroundImage = `url('${p.image}')`;

            const checkNew = document.getElementById('p-is-new');
            const checkStock = document.getElementById('p-stock');
            checkNew.checked = p.isNew;
            checkStock.checked = p.stock;
            toggleCheckStyle(checkNew);
            toggleCheckStyle(checkStock);
        }

        // Manejar URL de imagen
        function previewUrl(url) {
            if(url) {
                document.getElementById('p-image-preview').style.backgroundImage = `url('${url}')`;
                document.getElementById('p-image-data').value = url; // Guardamos la URL como data final
            }
        }

        // Manejar subida de archivo (Base64)
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const result = e.target.result;
                    document.getElementById('p-image-data').value = result;
                    document.getElementById('p-image-preview').style.backgroundImage = `url('${result}')`;
                    document.getElementById('p-img-url').value = ''; // Borrar URL si se sube archivo
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('p-id').value;
            
            // Prioridad: 1. URL escrita, 2. Data Base64 (archivo o URL previa), 3. Placeholder
            let finalImg = document.getElementById('p-img-url').value;
            if(!finalImg) finalImg = document.getElementById('p-image-data').value;
            if(!finalImg) finalImg = "https://via.placeholder.com/400";

            const productData = {
                name: document.getElementById('p-name').value,
                category: document.getElementById('p-category').value,
                price: parseFloat(document.getElementById('p-price').value),
                oldPrice: document.getElementById('p-old-price').value ? parseFloat(document.getElementById('p-old-price').value) : 0,
                desc: document.getElementById('p-desc').value,
                stock: document.getElementById('p-stock').checked,
                isNew: document.getElementById('p-is-new').checked,
                image: finalImg
            };

            const promise = id ? productsRef.doc(id).update(productData) : productsRef.add(productData);
            
            promise.then(() => closeModal('admin-product-modal'))
                   .catch(err => alert("Error al guardar: " + err.message));
        }

        function deleteProductFromModal() {
            if (!activeModalProductId) return;
            if(confirm("쮼liminar producto?")) {
                productsRef.doc(activeModalProductId).delete()
                    .then(() => closeModal('product-modal'));
            }
        }

        // --- 7. OTROS ---
        function promptAdminLogin() {
            if (prompt("Contrase침a:") === ADMIN_PASS) {
                state.isAdmin = true;
                localStorage.setItem('pinpon_admin_logged', 'true');
                renderAll();
            } else alert("Error");
        }

        function logoutAdmin() {
            state.isAdmin = false;
            localStorage.removeItem('pinpon_admin_logged');
            renderAll();
        }

        function updateSettings() {
            configRef.update({ exchangeRate: parseFloat(document.getElementById('exchange-rate').value) });
        }

        function editBanner() {
            if(!state.isAdmin) return;
            const t = prompt("Nuevo T칤tulo:", state.bannerTitle);
            const s = prompt("Nuevo Subt칤tulo:", state.bannerSub);
            if(t || s) configRef.update({ bannerTitle: t || state.bannerTitle, bannerSub: s || state.bannerSub });
        }

        // --- 8. HELPERS CARRITO Y MODALES ---
        function updateCardQty(id, change) {
            const el = document.getElementById(`card-qty-${id}`);
            let val = parseInt(el.innerText) + change;
            if (val < 1) val = 1;
            el.innerText = val;
        }
        function addFromCard(id) {
            addToCart(id, parseInt(document.getElementById(`card-qty-${id}`).innerText));
        }
        function addToCart(id, qty) {
            const p = state.products.find(x => x.id === id);
            if (!p) return;
            const exist = state.cart.find(x => x.id === id);
            if(exist) exist.qty += qty;
            else state.cart.push({ id: id, qty: qty });
            saveDataLocal();
            updateCartIcon();
            // Animaci칩n
            const badge = document.getElementById('cart-count');
            badge.style.transform = "scale(1.5)";
            setTimeout(() => badge.style.transform = "scale(1)", 200);
        }
        function updateCartIcon() {
            document.getElementById('cart-count').innerText = state.cart.reduce((s, i) => s + i.qty, 0);
        }
        function openProductModal(id) {
            activeModalProductId = id;
            const p = state.products.find(x => x.id === id);
            document.getElementById('modal-img').src = p.image;
            document.getElementById('modal-title').innerText = p.name;
            document.getElementById('modal-desc').innerText = p.desc;
            document.getElementById('modal-price').innerText = `$${p.price}`;
            const mn = (p.price * state.exchangeRate).toFixed(0);
            document.getElementById('modal-mn-price').innerText = `(${mn} MN)`;
            document.getElementById('admin-product-actions').style.display = state.isAdmin ? 'flex' : 'none';
            openModal('product-modal');
        }
        function openCategoryManager(open) {
            const list = document.getElementById('category-list-admin');
            list.innerHTML = '';
            categoriesRef.get().then(snap => {
                snap.forEach(doc => {
                    list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:5px;"><span>${doc.data().name}</span><button onclick="deleteCat('${doc.id}')" style="color:red;border:none;">X</button></div>`;
                });
            });
            if(open) openModal('category-manager-modal');
        }
        function addCategory() {
            const val = document.getElementById('new-category-input').value;
            if(val) categoriesRef.add({name: val}).then(() => openCategoryManager(false));
        }
        function deleteCat(id) {
            if(confirm("Borrar?")) categoriesRef.doc(id).delete().then(() => openCategoryManager(false));
        }
        // Helper Modales
        function openCart() { 
            const c = document.getElementById('cart-items'); c.innerHTML=''; 
            let total=0;
            state.cart.forEach((i, idx) => {
                const p = state.products.find(x=>x.id===i.id);
                if(p) {
                    total+=p.price*i.qty;
                    c.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${p.name} (${i.qty})</span><span>$${p.price*i.qty}</span><button onclick="removeCart(${idx})" style="color:red;border:none;">X</button></div>`;
                }
            });
            document.getElementById('cart-total').innerText = `$${total} USD`;
            openModal('cart-modal'); 
        }
        function removeCart(idx){ state.cart.splice(idx,1); saveDataLocal(); openCart(); updateCartIcon(); }
        function openMenu() { openModal('menu-modal'); }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        init();
    </script>
</body>
</html>
